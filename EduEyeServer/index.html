<!DOCTYPE html>
<html>
  <head>
    <title>EduEye - Desktop</title>
      <link type="text/css" rel="stylesheet" href="css/main.css" />
	  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
	  <script src="res/jquery.waitforimages.js"></script>
	  <script src="res/jquery.qrcode-0.7.0.min.js"></script>
  </head>



  <body>

  	<div id="qr" class="page">
  		<canvas id="qrcode"></canvas>
	    <p>Read the QR-code with your mobile device</p>
  	</div>

	<div id="camera" class="page hidden">
        <ul data-role="listview" data-inset="true" >
            <li>
                <div class="live_image_box" id="video_plane">
                    <img id="live_image" src="images/black.png">
                </div>
              <!--  <div>
                    <div id="player" style="display:block;height:32px;"></div>   
                </div>    -->
            </li>
            <li data-role="fieldcontain" class="center">
                <div class="center">
                    <span>Video size:</span>
                    <select name="resolution-choice" id="resolution-choice" data-native-menu="false">
                    </select>
                    <input id="btn_play" type="button" value="Play Video"/>
                </div>
            </li>
        </ul>
        <!-- for debug -->
        <div id="bottom_div">
            <span id="debug_msg">Connecting...</span>
        </div>

	</div><!-- page -->

</body>

  <script>

 //////////////////////////////////////////////
 // Showing the pics
 //////////////////////////////////////////////



//////////////////////////////////////////////
// Global variable define
//////////////////////////////////////////////
var planeWidth = 0;
var planeHeight = 0;
var basicURL = "";
var inStreaming = false;
var picCount = 0;

function CameraSize () {
    this.width = 0;
    this.height = 0;
}
var supportedSize = new Array();
var currentSize = new CameraSize();

//////////////////////////////////////////////
// Global function define
//////////////////////////////////////////////
var onImageLoadOK = function() {
    var wid = 0;
    var hei = 0;
    if ( planeHeight * currentSize.width / currentSize.height > planeWidth) {
        wid = planeWidth;
        hei = math.round(planeWidth * currentSize.height / currentSize.width); 
    } else {
        hei = planeHeight;
        wid = planeHeight * currentSize.width / currentSize.height;  
    }
    $("#live_image").width(wid);
    $("#live_image").height(hei);

    if ( inStreaming == true)
        setTimeout(refreshLive, 300);  
};

var onImageLoadError = function() {
};

var onQueryDone = function (ret) {
	$('#qr').addClass('hidden');
	$('#camera').removeClass('hidden');
    
    console.log("In query done, just hid the QR code");

    $("#resolution-choice").empty();
    var resList = ret.split("|");
    currentSize.width = resList[0].split("x")[0];
    currentSize.height = resList[0].split("x")[1];
    var currentSelect = -1;
    for(var i = 1; i < resList.length; i++) {
        var res = resList[i].split("x");
        var newRes = new CameraSize();
        newRes.width = res[0];
        newRes.height = res[1];    
        supportedSize.push(newRes);
        if ( newRes.width == currentSize.width  && newRes.height == currentSize.height) {
            currentSelect = i;
            var newOption = "<option value='" + (i-1) + "'>" + resList[i] + "</option>";
            $("#resolution-choice").append(newOption);
        }
    }
    for(var i = 1; i < resList.length; i++) {
        if ( currentSelect != i) {
            var newOption = "<option value='" + (i-1) + "'>" + resList[i] + "</option>";
            $("#resolution-choice").append(newOption);
        }
    }
    $("#resolution-choice").bind("change", doChangeRes);  

    $("#debug_msg").html("Connected");
};

var onHttpError = function (err) {
    $("#debug_msg").html("Can't connected with phone, please refresh web page!");  
    console.log("Something went wrong..."); 
    console.log("Error: ", err);
};

var refreshLive = function() {
    picCount = picCount + 1;
    $("#live_image").attr("src", basicURL + "stream/live.jpg?id=" + picCount);
    $("#live_image").waitForImages( onImageLoadOK );
};

var playClick = function () {
    if  ( inStreaming == false) {
        inStreaming = true;
        $("#btn_play").val("Stop");
        
        refreshLive();

    } else {
        inStreaming = false;
        $("#btn_play").val("Play");
    }
};

var onSetupOK = function() {
    var targetIndex = $("#resolution-choice").val();
    currentSize = supportedSize[targetIndex]; 
};

var doChangeRes = function () {
    var targetIndex = $("#resolution-choice").val();
    var wid = supportedSize[targetIndex].width;
    var hei = supportedSize[targetIndex].height; 
    $.ajax({
        type: "GET",
        url: basicURL + "cgi/setup",
        cache: false,
        data: "wid=" + wid + "&hei=" + hei,
        success: onSetupOK
    });
};


 //////////////////////////////////////////////
 // QR-Code
//////////////////////////////////////////////
  var qr = function(text) {
  	console.log("Darwing QR-code ", text);
  	var canvas = document.getElementById('qrcode');
  	canvas.height = 350; 
  	canvas.width = 350;

  	$('#qrcode').qrcode({ecLevel:'H', size: 350, label: 'EduEye', fontcolor: '#3498db', fontname: 'Arial', mode: 2, text: text});
  }



//////////////////////////////////////////////
 // UDP-Server
//////////////////////////////////////////////

	var dgram = require('dgram');
	var fs = require('fs');

	var PORT = 55555;

	var server = dgram.createSocket('udp4'); 
	server.on('message', function (msg, rinfo) {
		console.log('server got: ' + msg + ' from ' + rinfo.address + ':' + rinfo.port); 
		
		//Start showing images
		basicURL = "http://" + rinfo.address + ':8080/'; 
		console.log("basicURL ", basicURL );

	    var screenHeight = $(window).height();
	    var screenWidth = $(window).width();
	    planeHeight = Math.round( screenHeight * 0.5);
	    planeWidth = Math.round( screenWidth * 0.80);

	    $("#video_plane").height(planeHeight);
	    $("#video_plane").width(planeWidth);

	    $("#btn_play").bind("click", playClick);
	    
	    setTimeout(function() {
		    $.ajax({
		        type: "GET",
		        url: basicURL + "cgi/query",
		        cache: false,
		        error: onHttpError,
		        success: onQueryDone
		    });

	    }, 2000);



	});

	server.on('listening', function() {
		var address = server.address(); 
		console.log('Server listening ' + address.address + ':' + address.port);
	});


	server.bind(PORT);




//////////////////////////////////////////////
 // Helper functions
//////////////////////////////////////////////

	function showQRCodeHideCamera() {
		$('#camera').addClass('hidden');
		$('#qr').removeClass('hidden');
		getIPAddress(qr);
	}


	function getIPAddress(callback) {
		var os=require('os');
		var ifaces=os.networkInterfaces();
		for (var dev in ifaces) {
		  var alias=0;
		  ifaces[dev].forEach(function(details){

		    if (details.family=='IPv4' && dev !='lo' && details.internal != true) {
		      console.log('Drawing IP: ' + dev+(alias?':'+alias:''),details.address + " " + details.internal);
		      //++alias;
		      callback(details.address);
		     return;	
		    }	
		  });
		}
	
		// TODO: If no IP-address is found, ask IP manually

	}


//////////////////////////////////////////////
 // Getting stuff done after load
//////////////////////////////////////////////

	$(document).ready(function() {
		getIPAddress(qr);
	});

  </script>
</html>